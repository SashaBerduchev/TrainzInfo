@page "/login"

@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider

<h3>Авторизація</h3>

<EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <input @bind="loginModel.Email" placeholder="Email" class="form-control mb-2" />
    <input @bind="loginModel.Password" placeholder="Пароль" type="password" class="form-control mb-2" />

    <button class="btn btn-primary">Увійти</button>

    @if (!string.IsNullOrEmpty(LoginError))
    {
        <div class="alert alert-danger mt-2">
            @LoginError
        </div>
    }
</EditForm>

@code {
    private LoginModel loginModel = new();
    private string LoginError = "";

    private async Task HandleLogin()
    {
        try
        {
            // Викликаємо API для логіну
            var result = await Http.PostAsJsonAsync("api/auth/login", loginModel);

            if (result.IsSuccessStatusCode)
            {
                // Припустимо, сервер повертає JWT токен як рядок
                var token = await result.Content.ReadAsStringAsync();

                // Зберігаємо токен у LocalStorage
                await LocalStorage.SetItemAsync("authToken", token);

                // Оновлюємо стан авторизації у CustomAuthStateProvider
                if (AuthStateProvider is CustomAuthStateProvider customAuthProvider)
                {
                    await customAuthProvider.CheckAuthenticationAsync();
                }

                // Переходимо на головну
                Navigation.NavigateTo("/");
            }
            else
            {
                var message = await result.Content.ReadAsStringAsync();
                LoginError = message;
                Console.WriteLine(message);
            }
        }
        catch (Exception ex)
        {
            LoginError = "Помилка під час логіну: " + ex.Message;
        }
    }

    private class LoginModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }
}
