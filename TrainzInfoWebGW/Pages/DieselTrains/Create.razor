@page "/diesel-trains/create"
@using TrainzInfoShared.DTO.GetDTO
@inject NavigationManager Navigation
@inject HttpClient Http

<h4>Дизель</h4>
<hr />

<div class="row">
    <div class="col-md-4">
        <EditForm Model="@diesel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- Серія -->
            <div class="form-group">
                <label>Серія </label>
                <div class="form-inline">
                    <InputSelect @bind-Value="diesel.Name" class="form-control">
                        @foreach (var item in NameList)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                    @* <NavLink class="btn btn-info ml-2" href="/create-seria">Додати Серію локомотиву</NavLink> *@
                </div>
            </div>

            <!-- Номер -->
            <div class="form-group">
                <label>Номер (приклад 001, 002)</label>
                <InputText @bind-Value="diesel.NumberTrain" class="form-control" />
            </div>

            
            <div class="form-group position-relative">
                <label>Депо</label>
                <InputText @bind-Value="depo" class="form-control" placeholder="Почніть вводити депо..."
                           @oninput="OnInputChanged" />

                @if (filteredDepot?.Any() == true)
                {
                    <ul class="list-group position-absolute w-100" style="z-index:1000;">
                        @foreach (var item in filteredDepot)
                        {
                            <li class="list-group-item list-group-item-action"
                                style="cursor:pointer;"
                                @onclick="() => SelectItem(item)">
                                @item
                            </li>
                        }
                    </ul>
                }
            </div>

            <!-- Область -->
            <div class="form-group">
                <label>Область </label>
                <div class="form-inline">
                    <InputSelect @bind-Value="diesel.Oblast" class="form-control">
                       
                        @foreach (var item in OblList)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                    @* <NavLink class="btn btn-info ml-2" href="/create-seria">Додати Серію локомотиву</NavLink> *@
                </div>
            </div>

            <!-- Завантаження картинки -->
            <div class="form-group">
                <label>Завантажити картинку</label>
                <InputFile OnChange="HandleFileSelected" />
                @if (!string.IsNullOrEmpty(imagePreview))
                {
                    <div class="mt-2">
                        <img src="@imagePreview" alt="preview" width="150" />
                    </div>
                }
            </div>
            <!-- Кнопка -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Створити</button>
            </div>
        </EditForm>
    </div>
</div>

@if (errors is not null)
{
    <H3>"Помилка збереження, зверніться до адміністратора";</H3>
    <div class="alert alert-danger mt-2">
        <p>@errors</p>
    </div>
}


@code {
    private DieselTrainsDTO diesel = new DieselTrainsDTO();
    private List<string> NameList = new List<string>();
    private List<string> DepotList = new List<string>();
    private List<string> filteredDepot = new List<string>();
    private List<string> OblList = new List<string>();
    private CancellationTokenSource debounceCts;
    private string depo;
    private string imagePreview;
    private string errors;
    
    protected override async Task OnInitializedAsync()
    {
        await Load();
        // Підписка на скрол через JS
        //await JS.InvokeVoidAsync("addLocomotiveScrollListener", DotNetObjectReference.Create(this));
        // Завантажуємо локомотиви з API
    }
    private async Task Load()
    {
        NameList.Add("Виберіть серію");
        DepotList.Add("Виберіть депо");
        // Імітація завантаження даних — в реальному випадку виклик API
        var series = await Http.GetFromJsonAsync<List<string>>("api/diesels/allmodels");
        var depots = await Http.GetFromJsonAsync<List<string>>("api/diesels/alldepos");
        var oblasts = await Http.GetFromJsonAsync<List<string>>("api/diesels/allobl");
        NameList.AddRange(series ?? new List<string>());
        DepotList.AddRange(depots ?? new List<string>());
        OblList.AddRange(oblasts ?? new List<string>());
    }
    
    private async Task HandleValidSubmit()
    {
        var result = await Http.PostAsJsonAsync("api/diesels/create", diesel);
        if (result.IsSuccessStatusCode)
        {
            // Тут можна викликати сервіс, який додає локомотив в базу через API
            Console.WriteLine($"Додано локомотив: {diesel.Name} {diesel.NumberTrain}");
            // Після успіху — навігація назад
            Navigation.NavigateTo("/diesel-trains");
        }
        else
        {
            errors = await result.Content.ReadAsStringAsync();
            Console.WriteLine($"Помилка: {errors}");
        }
    }
    private async Task OnInputChanged(ChangeEventArgs e)
    {
        depo = e.Value?.ToString() ?? "";

        // скидаємо попередній debounce
        debounceCts?.Cancel();
        debounceCts = new CancellationTokenSource();
        var token = debounceCts.Token;

        try
        {
            await Task.Delay(300, token); // debounce 300 мс

           if (!token.IsCancellationRequested)
            {
                if (string.IsNullOrWhiteSpace(depo))
                {
                    filteredDepot.Clear();
                }
                else
                {
                    filteredDepot = DepotList
                        .Where(x => x.Contains(depo, StringComparison.OrdinalIgnoreCase))
                        .Take(7)
                        .ToList();
                }
                StateHasChanged();
            }
        }
        catch (TaskCanceledException)
        {
            // нормально, просто перервано
        }
    }

    private void SelectItem(string item)
    {
        depo = item;
        diesel.DepotList = depo;
        filteredDepot.Clear();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
        var buffer = new byte[file.Size];
        await stream.ReadAsync(buffer);

        imagePreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";

        // Зберігаємо у модель
        diesel.Image = imagePreview;
        diesel.ImageMimeTypeOfData = file.ContentType;
    }
}