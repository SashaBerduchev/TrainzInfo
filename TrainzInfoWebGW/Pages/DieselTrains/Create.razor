@page "/diesel-trains/create"
@using TrainzInfoShared.DTO.GetDTO
@inject NavigationManager Navigation
@inject HttpClient Http

<h4>–î–∏–∑–µ–ª—å</h4>
<hr />

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm rounded-4">
                <div class="card-body p-4">
                    <h4 class="mb-4 fw-semibold">üöÜ –î–∏–∑–µ–ª—å–Ω–∏–π –ª–æ–∫–æ–º–æ—Ç–∏–≤</h4>

                    <EditForm Model="@diesel" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <!-- –°–µ—Ä—ñ—è -->
                        <div class="mb-3">
                            <label class="form-label fw-medium">
                                –°–µ—Ä—ñ—è
                            </label>
                            <InputSelect @bind-Value="diesel.Name"
                                         class="form-select form-select-lg">
                                @foreach (var item in NameList)
                                {
                                    <option value="@item">@item</option>
                                }
                            </InputSelect>
                        </div>

                        <!-- –ù–æ–º–µ—Ä -->
                        <div class="mb-3">
                            <label class="form-label fw-medium">
                                –ù–æ–º–µ—Ä –ª–æ–∫–æ–º–æ—Ç–∏–≤–∞
                            </label>
                            <InputText @bind-Value="diesel.NumberTrain"
                                       class="form-control form-control-lg"
                                       placeholder="001, 002..." />
                        </div>

                        <!-- –î–µ–ø–æ -->
                        <div class="mb-3 position-relative">
                            <label class="form-label fw-medium">
                                –î–µ–ø–æ
                            </label>
                            <InputText @bind-Value="depo"
                                       class="form-control form-control-lg"
                                       placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –¥–µ–ø–æ..."
                                       @oninput="OnInputChanged" />

                            @if (filteredDepot?.Any() == true)
                            {
                                <ul class="list-group position-absolute w-100 shadow-sm rounded-3 mt-1 dropdown"
                                    style="z-index:1000;">
                                    @foreach (var item in filteredDepot)
                                    {
                                        <li class="list-group-item list-group-item-action"
                                            style="cursor:pointer;"
                                            @onclick="() => SelectItem(item)">
                                            @item
                                        </li>
                                    }
                                </ul>
                            }
                        </div>

                        <!-- –û–±–ª–∞—Å—Ç—å -->
                        <div class="mb-4">
                            <label class="form-label fw-medium">
                                –û–±–ª–∞—Å—Ç—å
                            </label>
                            <InputSelect @bind-Value="diesel.Oblast"
                                         class="form-select form-select-lg">
                                @foreach (var item in OblList)
                                {
                                    <option value="@item">@item</option>
                                }
                            </InputSelect>
                        </div>

                        <!-- –§–æ—Ç–æ -->
                        <div class="mb-4">
                            <label class="form-label fw-medium">
                                –§–æ—Ç–æ –ª–æ–∫–æ–º–æ—Ç–∏–≤–∞
                            </label>
                            <InputFile class="form-control"
                                       OnChange="HandleFileSelected" />

                            @if (!string.IsNullOrEmpty(imagePreview))
                            {
                                <div class="mt-3 text-center">
                                    <img src="@imagePreview"
                                         class="img-thumbnail rounded-3"
                                         style="max-height:180px" />
                                </div>
                            }
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ -->
                        <div class="d-flex justify-content-end">
                            <button type="submit"
                                    class="btn btn-primary btn-lg px-4">
                                –ó–±–µ—Ä–µ–≥—Ç–∏
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errors))
            {
                <div class="alert alert-danger mt-3 rounded-3">
                    <strong>–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</strong><br />
                    @errors
                </div>
            }
        </div>
    </div>
</div>



@code {
    private DieselTrainsDTO diesel = new DieselTrainsDTO();
    private List<string> NameList = new List<string>();
    private List<string> DepotList = new List<string>();
    private List<string> filteredDepot = new List<string>();
    private List<string> OblList = new List<string>();
    private CancellationTokenSource debounceCts;
    private string depo;
    private string imagePreview;
    private string errors;
    
    protected override async Task OnInitializedAsync()
    {
        await Load();
        // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–∫—Ä–æ–ª —á–µ—Ä–µ–∑ JS
        //await JS.InvokeVoidAsync("addLocomotiveScrollListener", DotNetObjectReference.Create(this));
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ª–æ–∫–æ–º–æ—Ç–∏–≤–∏ –∑ API
    }
    private async Task Load()
    {
        NameList.Add("–í–∏–±–µ—Ä—ñ—Ç—å —Å–µ—Ä—ñ—é");
        DepotList.Add("–í–∏–±–µ—Ä—ñ—Ç—å –¥–µ–ø–æ");
        // –Ü–º—ñ—Ç–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö ‚Äî –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É –≤–∏–ø–∞–¥–∫—É –≤–∏–∫–ª–∏–∫ API
        var series = await Http.GetFromJsonAsync<List<string>>("api/diesels/allmodels");
        var depots = await Http.GetFromJsonAsync<List<string>>("api/diesels/alldepos");
        var oblasts = await Http.GetFromJsonAsync<List<string>>("api/diesels/allobl");
        NameList.AddRange(series ?? new List<string>());
        DepotList.AddRange(depots ?? new List<string>());
        OblList.AddRange(oblasts ?? new List<string>());
    }
    
    private async Task HandleValidSubmit()
    {
        var result = await Http.PostAsJsonAsync("api/diesels/create", diesel);
        if (result.IsSuccessStatusCode)
        {
            // –¢—É—Ç –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Å–µ—Ä–≤—ñ—Å, —è–∫–∏–π –¥–æ–¥–∞—î –ª–æ–∫–æ–º–æ—Ç–∏–≤ –≤ –±–∞–∑—É —á–µ—Ä–µ–∑ API
            Console.WriteLine($"–î–æ–¥–∞–Ω–æ –ª–æ–∫–æ–º–æ—Ç–∏–≤: {diesel.Name} {diesel.NumberTrain}");
            // –ü—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É ‚Äî –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è –Ω–∞–∑–∞–¥
            Navigation.NavigateTo("/diesel-trains");
        }
        else
        {
            errors = await result.Content.ReadAsStringAsync();
            Console.WriteLine($"–ü–æ–º–∏–ª–∫–∞: {errors}");
        }
    }
    private async Task OnInputChanged(ChangeEventArgs e)
    {
        depo = e.Value?.ToString() ?? "";

        // —Å–∫–∏–¥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π debounce
        debounceCts?.Cancel();
        debounceCts = new CancellationTokenSource();
        var token = debounceCts.Token;

        try
        {
            await Task.Delay(300, token); // debounce 300 –º—Å

           if (!token.IsCancellationRequested)
            {
                if (string.IsNullOrWhiteSpace(depo))
                {
                    filteredDepot.Clear();
                }
                else
                {
                    filteredDepot = DepotList
                        .Where(x => x.Contains(depo, StringComparison.OrdinalIgnoreCase))
                        .Take(7)
                        .ToList();
                }
                StateHasChanged();
            }
        }
        catch (TaskCanceledException)
        {
            // –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–≤–∞–Ω–æ
        }
    }

    private void SelectItem(string item)
    {
        depo = item;
        diesel.DepotList = depo;
        filteredDepot.Clear();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
        var buffer = new byte[file.Size];
        await stream.ReadAsync(buffer);

        imagePreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —É –º–æ–¥–µ–ª—å
        diesel.Image = imagePreview;
        diesel.ImageMimeTypeOfData = file.ContentType;
    }
}