@page "/electric-trains/create"
@using TrainzInfoShared.DTO.GetDTO
@inject NavigationManager Navigation
@inject HttpClient Http

<h4>Локомотиви</h4>
<hr />

<div class="row">
    <div class="col-md-4">
        <EditForm Model="@electrics" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- Серія -->
            <div class="form-group">
                <label>Назва електрички</label>
                <div class="form-inline">
                    <InputSelect @bind-Value="electrics.Name" class="form-control">
                        @foreach (var item in NameList)
                        {
                            <option value="@item">@item</option>
                        }
                    </InputSelect>
                    @* <NavLink class="btn btn-info ml-2" href="/create-seria">Додати Серію локомотиву</NavLink> *@
                </div>
            </div>

            <!-- Номер -->
            <div class="form-group">
                <label>Модель</label>
                <InputText @bind-Value="electrics.Model" class="form-control" />
            </div>



            <!-- Депо -->
            <div class="form-group">
                <label>Депо</label>
                <InputSelect @bind-Value="electrics.DepotList" class="form-control">
                    @foreach (var item in DepotList)
                    {
                        <option value="@item">@item</option>
                    }
                </InputSelect>
            </div>

            <!-- Депо -->
            <div class="form-group">
                <label>Область</label>
                <InputSelect @bind-Value="electrics.Oblast" class="form-control">
                    @foreach (var item in OblList)
                    {
                        <option value="@item">@item</option>
                    }
                </InputSelect>
            </div>

            <!-- Конструкційна швидкість -->
            <div class="form-group">
                <label>Конструкційна швидкість</label>
                <InputNumber @bind-Value="electrics.MaxSpeed" class="form-control" />
            </div>

            <!-- Завантаження картинки -->
            <div class="form-group">
                <label>Завантажити картинку</label>
                <InputFile OnChange="HandleFileSelected" />
                @if (!string.IsNullOrEmpty(imagePreview))
                {
                    <div class="mt-2">
                        <img src="@imagePreview" alt="preview" width="150" />
                    </div>
                }
            </div>
            <!-- Кнопка -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Створити</button>
            </div>
        </EditForm>
    </div>
</div>

@if (errors is not null)
{
    <H3>"Помилка збереження, зверніться до адміністратора";</H3>
    <div class="alert alert-danger mt-2">
        <p>@errors</p>
    </div>
}


<div>
    <NavLink href="/electric-trains">Back to List</NavLink>
</div>

@code {
    private ElectricTrainSetDTO electrics = new ElectricTrainSetDTO();

    // Приклад даних для dropdown — в реальному випадку можна отримувати через сервіс/API
    private List<string> NameList = new List<string>();
    private List<string> DepotList = new List<string>();
    private List<string> OblList = new List<string>();
    private List<string> Plant = new List<string>();
    private string imagePreview;
    private string errors;

    protected override async Task OnInitializedAsync()
    {

        await Load();
        // Підписка на скрол через JS
        //await JS.InvokeVoidAsync("addLocomotiveScrollListener", DotNetObjectReference.Create(this));
        // Завантажуємо локомотиви з API
    }

    private async Task Load()
    {
        NameList.Add("Виберіть назву");
        DepotList.Add("Виберіть депо");
        // Імітація завантаження даних — в реальному випадку виклик API
        var series = await Http.GetFromJsonAsync<List<string>>("api/electrictrains/getallnames");
        var depots = await Http.GetFromJsonAsync<List<string>>("api/electrictrains/getalldepots");
        var plants = await Http.GetFromJsonAsync<List<string>>("api/electrictrains/getplants");
        var oblasts = await Http.GetFromJsonAsync<List<string>>("api/electrictrains/allobl");
        NameList.AddRange(series ?? new List<string>());
        DepotList.AddRange(depots ?? new List<string>());
        Plant.AddRange(plants ?? new List<string>());
        OblList.AddRange(oblasts ?? new List<string>());
    }

    private async Task HandleValidSubmit()
    {
        var result = await Http.PostAsJsonAsync("api/electrictrains/create", electrics);
        if (result.IsSuccessStatusCode)
        {
            // Тут можна викликати сервіс, який додає локомотив в базу через API
            Console.WriteLine($"Додано електричку: {electrics.Name} {electrics.Model}");
            // Після успіху — навігація назад
            Navigation.NavigateTo("/electric-trains");
        }
        else
        {
            errors = await result.Content.ReadAsStringAsync();
            Console.WriteLine($"Помилка: {errors}");
        }


    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
        var buffer = new byte[file.Size];
        await stream.ReadAsync(buffer);

        imagePreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";

        // Зберігаємо у модель
        electrics.Image = imagePreview;
        electrics.ImageMimeTypeOfData = file.ContentType;
    }
}