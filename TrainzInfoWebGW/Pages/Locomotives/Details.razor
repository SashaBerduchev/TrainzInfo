@page "/locomotives/details/{Id:int}"
@using System.Net.Http.Json
@using TrainzInfoShared.DTO.GetDTO
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS


<h3 class="mb-4 text-primary">@Title</h3>

@if (IsLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-info" role="status"></div>
        <p class="mt-3">Завантаження...</p>
    </div>
}
else if (Error != null)
{
    <div class="alert alert-danger">
        <strong>Помилка:</strong> @Error
    </div>
    <div class="mt-3">
        <NavLink class="btn btn-secondary" href="/locomotives">
            <i class="fa-solid fa-arrow-left"></i> Повернутися до списку
        </NavLink>
    </div>
}
else
{
    <div class="container my-4">
        <hr />

        <!-- Основний блок -->
        <div class="card shadow-lg p-4 mb-4">
            <div class="row g-4 align-items-center">

                <!-- Зображення -->
                <div class="col-12 col-md-5 text-center">
                    @if (!string.IsNullOrEmpty(Locomotive.ImgSrc))
                    {
                        <img class="img-fluid rounded shadow-sm"
                             src="@Locomotive.ImgSrc"
                             alt="Локомотив" />
                    }
                    else
                    {
                        <p class="text-muted">Зображення відсутнє</p>
                    }
                </div>

                <!-- Інформація -->
                <div class="col-12 col-md-7">
                    <h4 class="text-info">@Locomotive.Seria - @Locomotive.Number</h4>
                    <ul class="list-group list-group-flush mt-3">
                        <li class="list-group-item">
                            <strong>Максимальна швидкість:</strong> @Locomotive.Speed км/год
                        </li>
                        <li class="list-group-item">
                            <strong>Місто прописки:</strong> @Locomotive.City
                        </li>
                        <li class="list-group-item">
                            <strong>Депо прописки:</strong> @Locomotive.Depot
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Станція -->
        @if (Locomotive.Station != null)
        {
            <div class="card shadow-sm mb-5 p-4">
                <div class="row g-4 align-items-start">
                    <!-- Картинка -->
                    <div class="col-md-4 text-center">
                        @if (!string.IsNullOrEmpty(Locomotive.StationImages))
                        {
                            <img src="@Locomotive.StationImages" class="img-fluid rounded shadow-sm" alt="@Locomotive.Station" />
                        }
                        else
                        {
                            <p class="text-muted">Зображення станції відсутнє</p>
                        }
                    </div>

                    <!-- Текстова частина -->
                    <div class="col-md-8">
                        <h5 class="text-primary mb-3">@Locomotive.Station</h5>
                        <dl class="row mb-3">
                            <dt class="col-sm-3 fw-bold">Місто</dt>
                            <dd class="col-sm-9">@Locomotive.City</dd>

                            <dt class="col-sm-3 fw-bold">Область</dt>
                            <dd class="col-sm-9">@Locomotive.Oblast</dd>
                        </dl>

                        <div class="mt-3">
                            @((MarkupString)Locomotive.StationInformation)
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <p class="text-muted">Завантаження інформації...</p>
        }

        <!-- Publisher/Admin -->
        @if (IsPublisherOrAdmin)
        {
            <div class="mt-3 text-center">
                <a class="btn btn-info" href="/edit-info/@Locomotive.Seria" target="_blank">
                    Редагувати додаткову інформацію
                </a>
            </div>
        }

        <!-- Додаткова інформація -->
        <div class="mt-4">
            <p class="fs-5">@Locomotive.BaseInfo</p>
            <p class="fs-5">@Locomotive.AllInfo</p>
        </div>

        <!-- Superadmin -->
        @if (IsSuperadmin)
        {
            <div class="mt-3 d-flex flex-wrap gap-2">
                <a class="btn btn-success" href="/locomotive/edit/@Locomotive.Id">Редагувати</a>
                <a class="btn btn-success" href="/locomotive/add-image/@Locomotive.Id">Додати зображення</a>
                <button class="btn btn-danger" @onclick="DeleteLocomotive">
                    Видалити
                </button>
            </div>
        }

        @if (ErrorMessage is not null)
        {
            <h3 class="text-danger mt-4">Помилка збереження, зверніться до адміністратора</h3>
            <div class="alert alert-danger mt-2">
                <p>@ErrorMessage</p>
            </div>
        }

        <!-- Кнопка назад -->
        <div class="mt-4">
            <NavLink class="btn btn-secondary d-flex align-items-center gap-2" href="/locomotives">
                <i class="fa-solid fa-arrow-left"></i> Повернутися до списку
            </NavLink>
        </div>
    </div>
}


@code {
    [Parameter] public int Id { get; set; }

    private LocomotiveDTO? Locomotive;

    private string Title = "Локомотив";
    private string? Error;
    private bool IsLoading = true;

    private string? ErrorMessage;

    private bool IsPublisherOrAdmin = false;
    private bool IsSuperadmin = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;

            // Авторизація
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = auth.User;

            IsPublisherOrAdmin =
                user.IsInRole("Publisher") ||
                user.IsInRole("Admin") ||
                user.IsInRole("Superadmin");

            IsSuperadmin = user.IsInRole("Superadmin");

            // Завантажуємо локомотив
            Locomotive = await Http.GetFromJsonAsync<LocomotiveDTO>($"api/locomotives/details/{Id}");

            if (Locomotive == null)
            {
                Error = "Локомотив не знайдено.";
                return;
            }

            Title = $"{Locomotive.Seria} - {Locomotive.Number}";
            Console.WriteLine("Locomotive.StationInformation: " + Locomotive.StationInformation);

        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }
    private async Task DeleteLocomotive()
    {
        if (!await Confirm("Ви впевнені що хочете видалити локомотив?"))
            return;

        var response = await Http.PostAsync($"api/locomotives/deleteapprove/{Id}", null);

        if (response.IsSuccessStatusCode)
            Nav.NavigateTo("/locomotives");

        else
            ErrorMessage = "Помилка видалення: " + await response.Content.ReadAsStringAsync();
    }

    private async Task<bool> Confirm(string message)
    {
        return await Task.FromResult(await JS.InvokeAsync<bool>("confirm", message));
    }

    public class Depot
    {
        public string Name { get; set; }
        public City City { get; set; }
    }

    public class City
    {
        public string Name { get; set; }
    }
}
