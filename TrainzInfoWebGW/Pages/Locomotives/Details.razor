@page "/locomotives/details/{Id:int}"
@using System.Net.Http.Json
@using TrainzInfoShared.DTO.GetDTO
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<h3>@Title</h3>

@if (IsLoading)
{
    <p>Loading...</p>
}
else if (Error != null)
{
    <div class="alert alert-danger">@Error</div>
    <div>
        <NavLink href="/locomotives">Back to List</NavLink>
    </div>
}
else
{
    <div class="container my-4">
        <hr />

        <div class="bg-light p-3 rounded">
            <div class="row g-3 align-items-center">

                <!-- Зображення -->
                <div class="col-12 col-md-5 text-center">
                    @if (Locomotive.ImgSrc != null)
                    {
                        <img class="img-fluid rounded-start"
                             src="@Locomotive.ImgSrc"
                             alt="Локомотив" />
                    }
                    else
                    {
                        <p>Зображення відсутнє</p>
                    }
                </div>

                <!-- Інформація -->
                <div class="col-12 col-md-7 bg-light p-3 rounded">
                    <h4>@Locomotive.Seria - @Locomotive.Number</h4>
                    <p>Максимальна швидкість: @Locomotive.Speed км/год</p>
                    <p>Місто прописки: @Locomotive.City</p>
                    <p>Депо прописки: @Locomotive.Depot</p>
                </div>

            </div>
        </div>

        <!-- Publisher/Admin -->
        @if (IsPublisherOrAdmin)
        {
            <div class="mt-3 text-center">
                <a class="btn btn-info" href="/edit-info/@Locomotive.Seria" target="_blank">
                    Редагувати додаткову інформацію
                </a>
            </div>
        }

        <div class="mt-4">
            <p class="fs-5">@BaseInfo</p>
            <p class="fs-5">@AllInfo</p>
        </div>

        <!-- Superadmin -->
        @if (IsSuperadmin)
        {
            <div class="mt-3 d-flex flex-wrap gap-2">
                <a class="btn btn-success" href="/locomotive/edit/@Locomotive.Id">Редагувати</a>
                <a class="btn btn-success" href="/locomotive/add-image/@Locomotive.Id">Додати зображення</a>
                <button class="btn btn-danger w-100 w-md-auto" @onclick="DeleteLocomotive">
                    Видалити
                </button>
            </div>
        }
        @if (ErrorMessage is not null)
        {
            <H3>"Помилка збереження, зверніться до адміністратора";</H3>
            <div class="alert alert-danger mt-2">
                        <p>@ErrorMessage</p>
            </div>
        }
    </div>
    <div>
        <NavLink href="/locomotives">Back to List</NavLink>
    </div>
}


@code {
    [Parameter] public int Id { get; set; }

    private LocomotiveDTO? Locomotive;

    private string? BaseInfo;
    private string? AllInfo;

    private string Title = "Локомотив";
    private string? Error;
    private bool IsLoading = true;

    private string? ErrorMessage;

    private bool IsPublisherOrAdmin = false;
    private bool IsSuperadmin = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;

            // Авторизація
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = auth.User;

            IsPublisherOrAdmin =
                user.IsInRole("Publisher") ||
                user.IsInRole("Admin") ||
                user.IsInRole("Superadmin");

            IsSuperadmin = user.IsInRole("Superadmin");

            // Завантажуємо локомотив
            Locomotive = await Http.GetFromJsonAsync<LocomotiveDTO>($"api/locomotives/getlocomotive/{Id}");

            if (Locomotive == null)
            {
                Error = "Локомотив не знайдено.";
                return;
            }

            Title = $"{Locomotive.Seria} - {Locomotive.Number}";

            // Завантажуємо зображення (як Base64)
            // var imgBytes = await Http.GetByteArrayAsync($"api/locomotive/{Id}/image");
            

            // Завантаження текстової інфи
            // BaseInfo = await Http.GetStringAsync($"api/locomotive/{Id}/baseinfo");
            // AllInfo = await Http.GetStringAsync($"api/locomotive/{Id}/allinfo");
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }
    private async Task DeleteLocomotive()
    {
        if (!await Confirm("Ви впевнені що хочете видалити локомотив?"))
            return;

        var response = await Http.DeleteAsync($"api/locomotives/deleteapprove/{Id}");

        if (response.IsSuccessStatusCode)
            Nav.NavigateTo("/locomotives");

        else
            ErrorMessage = "Помилка видалення: " + await response.Content.ReadAsStringAsync();
    }

    private async Task<bool> Confirm(string message)
    {
        return await Task.FromResult(await JS.InvokeAsync<bool>("confirm", message));
    }

    public class Depot
    {
        public string Name { get; set; }
        public City City { get; set; }
    }

    public class City
    {
        public string Name { get; set; }
    }
}
