@page "/news/details/{id:int}"
@inject NavigationManager Navigation
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject IJSRuntime JS

@*  Заголовок страницы новости *@
<h1 class="news-page-title mb-4">@((MarkupString)news?.NameNews)</h1>

@if (news is not null)
{
    <div class="card shadow-sm news-detail-card">
        <!-- 1️⃣ Устанавливаем flex‑order:
              при больших экранах картинка идёт справа (order-2),
              но в mobile остаётся первой (order-1) -->
        <div class="row g-4 g-lg-5 align-items-start">

            @*  Текстовая часть новости – первая колонка для мобильных, 
            в больших экранах будет слева (order-1) *@
            <section class="col-md-8 order-1 order-lg-2">
                <dl class="row mb-4">

                    <dt class="col-sm-3 fw-semibold text-secondary">Назва</dt>
                    <dd class="col-sm-9 news-text">@((MarkupString)news.NameNews)</dd>

                    <dt class="col-sm-3 fw-semibold text-secondary">Коротко</dt>
                    <dd class="col-sm-9 news-text">@((MarkupString)news.BaseNewsInfo)</dd>

                    <dt class="col-sm-3 fw-semibold text-secondary">Повна інформація</dt>
                    <dd class="col-sm-9 news-text">@((MarkupString)news.NewsInfoAll)</dd>
                </dl>

                <!-- 2️⃣ Кнопки действий -->
                <div class="d-flex flex-wrap gap-2">
                    @if (CanComment)
                    {
                        <button class="btn btn-info btn-sm"
                                @onclick="() => NavigateToComment(news.id)">
                            Коментувати
                        </button>
                        <button class="btn btn-info btn-sm"
                                @onclick="() => NavigateToComments(news.id)">
                            Коментарі + @CommentCount
                        </button>
                    }
                    @if (IsAdmin)
                    {
                        <button class="btn btn-outline-info btn-sm"
                                @onclick="() => EditNews(news.id)">
                            Редагувати інформацію
                        </button>
                        <button class="btn btn-outline-info btn-sm"
                                @onclick="() => AddImage(news.id)">
                            Додати картинку
                        </button>
                    }
                </div>
            </section>

            @*  Картинка новости – вторая колонка, но order-2 на больших экранах 
            (появляется справа), order-1 в мобильном режиме *@
            <figure class="col-md-4 text-center mb-3 mb-md-0 order-2 order-lg-1">
                @if (!string.IsNullOrWhiteSpace(news.NewsImage))
                {
                    <img src="@news.NewsImage"
                         alt="@news.NameNews"
                         class="img-fluid rounded news-detail-img" />
                }
                else
                {
                    <!-- placeholder, если картинки нет -->
                    <div class="placeholder-img d-flex align-items-center justify-content-center">
                        <span class="text-muted">Нет изображения</span>
                    </div>
                }
            </figure>

        </div>
    </div>
}
else
{
    <p class="text-muted">Завантаження новини…</p>
}

@code {
    [Parameter] public int Id { get; set; }

    private NewsDTO news;
    private UserDto CurrentUser; // або отримуй з авторизації
    private int CommentCount;

    private bool IsAdmin = false;
    private bool CanComment = false;

    protected override async Task OnInitializedAsync()
    {
        // Завантажуємо новину
        news = await Http.GetFromJsonAsync<NewsDTO>($"api/news/details/{Id}");

        // Приклад: завантаження поточного користувача та кількості коментарів
        // CurrentUser = await Http.GetFromJsonAsync<UserDto>("api/users/current");
        CommentCount = await Http.GetFromJsonAsync<int>($"api/comments/getnewscommentscount/{Id}");
        await CheckRoles();
    }

    private async Task CheckRoles()
    {
        if (AuthStateProvider is CustomAuthStateProvider customAuth)
        {
            // Перевірка стану авторизації на сервері
            await customAuth.CheckAuthenticationAsync();

            // Отримуємо ClaimsPrincipal
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated ?? false)
            {
                var email = user.Identity.Name;
                var roles = user.Claims
                                .Where(c => c.Type == ClaimTypes.Role)
                                .Select(c => c.Value)
                                .ToList();

                IsAdmin = roles.Contains("Admin") || roles.Contains("Superadmin") || roles.Contains("Publisher");

                if (user.Identity.Name != null)
                {
                    CanComment = true;
                }
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        var uri = new Uri(Nav.Uri);                            // полный URL, например https://app.com/news?id=42
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (!int.TryParse(query["id"], out int newsId))
        {
            // id не найден/не число – можно показать ошибку или перейти на другую страницу
            return;
        }

        // 2️⃣ Загружаем новость по полученному id
        var news = await Http.GetFromJsonAsync<NewsDTO>($"api/news/{newsId}");

        if (news == null) return; // ничего не найдено

        // 3️⃣ Обновляем Open Graph‑теги через JS‑интероп
        await JS.InvokeVoidAsync(
            "og.setMetaTags",
            news.NameNews,
            // если BaseNewsInfo может быть null, берём часть от начала строки,
            // иначе – саму строку (или обрезаем до 150 символов)
            string.IsNullOrWhiteSpace(news.BaseNewsInfo)
                ? ""
                : news.BaseNewsInfo.Length > 150
                    ? news.BaseNewsInfo[..150]
                    : news.BaseNewsInfo,
                    news.NewsImage
        );
    }


    private void NavigateToComment(int newsId)
    {
        Navigation.NavigateTo($"/newscomments/create/{newsId}");
    }

    private void NavigateToComments(int newsId)
    {
        Navigation.NavigateTo($"/newscomments/{newsId}");
    }

    private void EditNews(int newsId)
    {
        Navigation.NavigateTo($"/news/edit/{newsId}");
    }

    private void AddImage(int newsId)
    {
        Navigation.NavigateTo($"/news/addimage/{newsId}");
    }
}
