@page "/news/details/{id:int}"
@inject NavigationManager Navigation
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject IJSRuntime JS

<h1 class="news-page-title">@news?.NameNews</h1>

@if (news != null)
{
    <div class="news-detail-card card shadow-sm mb-5">
        <div class="row g-4 align-items-start">
            <!-- Картинка -->
            <div class="col-md-4 text-center">
                @if (string.IsNullOrEmpty(news.NewsImage))
                {
                    <img src="@news.NewsImage" class="img-fluid rounded news-detail-img" alt="Новина" />
                }
                else
                {
                    <img src="@news.NewsImage" class="card-img-top" alt="@news.NameNews" />
                }
            </div>

            <!-- Текстова частина -->
            <div class="col-md-8">
                <dl class="row mb-3">
                    <dt class="col-sm-3">Назва</dt>
                    <dd class="col-sm-9 news-text">@((MarkupString)news.NameNews)</dd>

                    <dt class="col-sm-3">Коротко</dt>
                    <dd class="col-sm-9 news-text">@((MarkupString)news.BaseNewsInfo)</dd>

                    <dt class="col-sm-3">Повна інформація</dt>
                    <dd class="col-sm-9 news-text">@((MarkupString)news.NewsInfoAll)</dd>
                </dl>

                <!-- Кнопки -->
                <div class="d-flex flex-wrap gap-2 mt-3">
                    @if (CanComment != null)
                    {
                        <button class="btn btn-info btn-sm" @onclick="() => NavigateToComment(news.id)">Коментувати</button>
                        <button class="btn btn-info btn-sm" @onclick="() => NavigateToComments(news.id)">
                            Коментарі + @CommentCount
                        </button>
                    }

                    @if (IsAdmin == true)
                    {
                        <button class="btn btn-outline-info btn-sm" @onclick="() => EditNews(news.id)">Редагувати інформацію</button>
                        <button class="btn btn-outline-info btn-sm" @onclick="() => AddImage(news.id)">Додати картинку</button>
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    <p>Завантаження новини...</p>
}

@code {
    [Parameter] public int Id { get; set; }

    private NewsDTO news;
    private UserDto CurrentUser; // або отримуй з авторизації
    private int CommentCount;

    private bool IsAdmin = false;
    private bool CanComment = false;

    protected override async Task OnInitializedAsync()
    {
        // Завантажуємо новину
        news = await Http.GetFromJsonAsync<NewsDTO>($"api/news/details/{Id}");

        // Приклад: завантаження поточного користувача та кількості коментарів
        // CurrentUser = await Http.GetFromJsonAsync<UserDto>("api/users/current");
        // CommentCount = await Http.GetFromJsonAsync<int>($"api/news/{Id}/comments/count");
        await CheckRoles();
    }

    private async Task CheckRoles()
    {
        if (AuthStateProvider is CustomAuthStateProvider customAuth)
        {
            // Перевірка стану авторизації на сервері
            await customAuth.CheckAuthenticationAsync();

            // Отримуємо ClaimsPrincipal
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated ?? false)
            {
                var email = user.Identity.Name;
                var roles = user.Claims
                                .Where(c => c.Type == ClaimTypes.Role)
                                .Select(c => c.Value)
                                .ToList();

                IsAdmin = roles.Contains("Admin") || roles.Contains("Superadmin") || roles.Contains("Publisher");

                if (user.Identity.Name != null)
                {
                    CanComment = true;
                }
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        var uri = new Uri(Nav.Uri);                            // полный URL, например https://app.com/news?id=42
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (!int.TryParse(query["id"], out int newsId))
        {
            // id не найден/не число – можно показать ошибку или перейти на другую страницу
            return;
        }

        // 2️⃣ Загружаем новость по полученному id
        var news = await Http.GetFromJsonAsync<NewsDTO>($"api/news/{newsId}");

        if (news == null) return; // ничего не найдено

        // 3️⃣ Обновляем Open Graph‑теги через JS‑интероп
        await JS.InvokeVoidAsync(
            "og.setMetaTags",
            news.NameNews,
            // если BaseNewsInfo может быть null, берём часть от начала строки,
            // иначе – саму строку (или обрезаем до 150 символов)
            string.IsNullOrWhiteSpace(news.BaseNewsInfo)
                ? ""
                : news.BaseNewsInfo.Length > 150
                    ? news.BaseNewsInfo[..150]
                    : news.BaseNewsInfo,
                    news.NewsImage
        );
    }


    private void NavigateToComment(int newsId)
    {
        Navigation.NavigateTo($"/newscomments/create/{newsId}");
    }

    private void NavigateToComments(int newsId)
    {
        Navigation.NavigateTo($"/newscomments/{newsId}");
    }

    private void EditNews(int newsId)
    {
        Navigation.NavigateTo($"/news/edit/{newsId}");
    }

    private void AddImage(int newsId)
    {
        Navigation.NavigateTo($"/news/addimage/{newsId}");
    }
}
